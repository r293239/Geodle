<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civile - Geography Challenge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c5530;
            --secondary-color: #4a7c59;
            --accent-color: #f2c94c;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-bg: #1a2f1a;
            --light-text: #f5f5f5;
            --glass-bg: rgba(255,255,255,0.1);
            --glass-border: rgba(255,255,255,0.2);
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--light-text);
            overflow-x: hidden;
        }

        /* Natural Background */
        .natural-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: 
                radial-gradient(circle at 20% 80%, rgba(76, 175, 80, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 195, 74, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(56, 142, 60, 0.1) 0%, transparent 50%);
        }

        .natural-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.05)"/></svg>') repeat,
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path d="M100,20 C120,40 140,60 160,80 C140,100 120,120 100,140 C80,120 60,100 40,80 C60,60 80,40 100,20 Z" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></svg>') repeat;
            animation: floatBackground 60s infinite linear;
        }

        @keyframes floatBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100px, -50px); }
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            position: relative;
            z-index: 1000;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
            position: relative;
        }

        .nav-link {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: var(--light-text);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-link:hover {
            background: var(--glass-bg);
            transform: translateY(-2px);
        }

        /* Game Modes Dropdown - FIXED: Made opaque */
        .game-modes-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(42, 67, 42, 0.95); /* Changed to opaque dark green */
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 10px;
            min-width: 200px;
            display: none;
            z-index: 1001;
            margin-top: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-modes-dropdown.show {
            display: block;
        }

        .mode-link {
            display: block;
            padding: 10px 15px;
            color: var(--light-text);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 5px 0;
        }

        .mode-link:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        /* Rest of your CSS remains the same... */
        /* (Keeping the rest of your CSS styles as they were) */

    </style>
</head>
<body>
    <!-- Natural Background -->
    <div class="natural-bg"></div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <div class="logo">üåç Civile</div>
        <div class="nav-links">
            <a href="#" class="nav-link" onclick="showPage('game')"><i class="fas fa-play"></i> Play</a>
            <a href="#" class="nav-link" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</a>
            <a href="#" class="nav-link" onclick="showPage('help')"><i class="fas fa-question-circle"></i> Help</a>
            
            <!-- Game Modes Dropdown -->
            <div class="nav-link" id="gameModesBtn">
                <i class="fas fa-globe-americas"></i> Game Modes
                <div class="game-modes-dropdown" id="gameModesDropdown">
                    <a href="https://geodle-game.netlify.app/" target="_blank" class="mode-link">
                        <i class="fas fa-map-marked-alt"></i> Geodle
                    </a>
                    <a href="https://geodle-game.netlify.app/path-mode.html" target="_blank" class="mode-link">
                        <i class="fas fa-route"></i> Routele
                    </a>
                    <a href="https://geodle-game.netlify.app/country-mode.html" target="_blank" class="mode-link">
                        <i class="fas fa-flag"></i> Countryle
                    </a>
                    <a href="https://geodle-game.netlify.app/flag-mode.html" target="_blank" class="mode-link">
                        <i class="fas fa-flag-usa"></i> Flagle
                    </a>
                </div>
            </div>
            
            <a href="https://docs.google.com/forms/d/1Sr-6EWcdBa7Hst9nyJLvTz7oU-eGozoYBpZTMKj7_mU/edit" target="_blank" class="nav-link"><i class="fas fa-heart"></i> Help Us Improve</a>
        </div>
    </nav>

    <!-- Your HTML content remains the same... -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Game Settings
        let gameSettings = {
            sound: true,
            timePressure: false,
            countryHint: false,
            difficulty: 3,
            darkMap: false,
            reducedAnim: false
        };

        // Game Statistics
        let gameStats = {
            totalGames: 0,
            totalScore: 0,
            correctAnswers: 0,
            totalAnswers: 0
        };

        class EnhancedCivileGame {
            constructor() {
                this.cities = [];
                this.score = 0;
                this.round = 1;
                this.streak = 0;
                this.bestTime = null;
                this.accuracy = 100;
                this.currentCity = null;
                this.gameActive = false;
                this.isPaused = false;
                this.timer = null;
                this.timeLeft = 10000;
                this.startTime = 0;
                this.highScores = [];
                this.map = null;
                this.markers = [];
                this.usedCities = [];
                this.hintUsed = false;
                this.correctAnswers = 0;
                this.totalAnswers = 0;
                this.achievements = [];
                
                this.loadSettings();
                this.loadStats();
                this.initializeElements();
                this.loadCitiesData(); // Load from external file
                this.initializeMap();
                this.setupEventListeners();
                this.updateDisplay();
                this.showLeaderboard();
            }
            
            async loadCitiesData() {
                try {
                    console.log('Loading cities data from cities-data.json...');
                    const response = await fetch('cities-data.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    this.cities = await response.json();
                    console.log('Successfully loaded cities:', this.cities.length);
                    
                    // Validate the data structure
                    if (!Array.isArray(this.cities) || this.cities.length === 0) {
                        throw new Error('Invalid cities data format');
                    }
                    
                    // Validate each city has required properties
                    this.cities.forEach((city, index) => {
                        if (!city.name || !city.lat || !city.lng) {
                            console.warn(`City at index ${index} is missing required properties:`, city);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error loading cities data:', error);
                    // Fallback to a small set of cities if the file can't be loaded
                    this.cities = [
                        {
                            "name": "Paris",
                            "lat": 48.8566,
                            "lng": 2.3522,
                            "hint": "City of Light, home to the Eiffel Tower and Louvre Museum",
                            "difficulty": 1,
                            "country": "France",
                            "population": "2.1M",
                            "landmark": "Eiffel Tower"
                        },
                        {
                            "name": "Tokyo",
                            "lat": 35.6762,
                            "lng": 139.6503,
                            "hint": "Japan's capital, famous for sushi, technology, and cherry blossoms",
                            "difficulty": 1,
                            "country": "Japan",
                            "population": "37M",
                            "landmark": "Tokyo Tower"
                        },
                        {
                            "name": "New York",
                            "lat": 40.7128,
                            "lng": -74.0060,
                            "hint": "The Big Apple, home to the Statue of Liberty and Times Square",
                            "difficulty": 1,
                            "country": "USA",
                            "population": "8.3M",
                            "landmark": "Statue of Liberty"
                        }
                    ];
                    console.log('Using fallback cities data:', this.cities.length);
                }
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('civile_settings');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.settings = { ...gameSettings, ...parsed };
                    } else {
                        this.settings = { ...gameSettings };
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                    this.settings = { ...gameSettings };
                }
            }

            saveSettings() {
                try {
                    localStorage.setItem('civile_settings', JSON.stringify(this.settings));
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            }

            loadStats() {
                try {
                    const saved = localStorage.getItem('civile_stats');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.stats = { ...gameStats, ...parsed };
                    } else {
                        this.stats = { ...gameStats };
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                    this.stats = { ...gameStats };
                }
                this.updateStatsDisplay();
            }

            saveStats() {
                this.stats.totalGames++;
                this.stats.totalScore += this.score;
                if (this.totalAnswers > 0) {
                    this.stats.correctAnswers += this.correctAnswers;
                    this.stats.totalAnswers += this.totalAnswers;
                }
                
                try {
                    localStorage.setItem('civile_stats', JSON.stringify(this.stats));
                } catch (error) {
                    console.error('Error saving stats:', error);
                }
                this.updateStatsDisplay();
            }

            updateStatsDisplay() {
                if (document.getElementById('totalGames')) {
                    document.getElementById('totalGames').textContent = this.stats.totalGames;
                    document.getElementById('totalScore').textContent = this.stats.totalScore.toLocaleString();
                    const avgAccuracy = this.stats.totalAnswers > 0 ? 
                        Math.round((this.stats.correctAnswers / this.stats.totalAnswers) * 100) : 0;
                    document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
                }
            }
            
            initializeElements() {
                this.scoreEl = document.getElementById('score');
                this.roundEl = document.getElementById('round');
                this.streakEl = document.getElementById('streak');
                this.bestTimeEl = document.getElementById('bestTime');
                this.accuracyEl = document.getElementById('accuracy');
                this.cityNameEl = document.getElementById('cityName');
                this.cityHintEl = document.getElementById('cityHint');
                this.timerFillEl = document.getElementById('timerFill');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.skipBtn = document.getElementById('skipBtn');
                this.hintBtn = document.getElementById('hintBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.leaderboardEl = document.getElementById('leaderboard');
                this.scoresListEl = document.getElementById('scoresList');
            }
            
            initializeMap() {
                this.map = L.map('map', {
                    center: [20, 0],
                    zoom: 2,
                    minZoom: 2,
                    maxZoom: 8,
                    worldCopyJump: true,
                    maxBounds: [[-90, -180], [90, 180]],
                    maxBoundsViscosity: 1.0
                });

                this.updateMapTheme();
                this.map.doubleClickZoom.disable();
            }

            updateMapTheme() {
                // Remove existing tile layer
                this.map.eachLayer((layer) => {
                    if (layer._url) {
                        this.map.removeLayer(layer);
                    }
                });

                // Add appropriate tile layer
                const tileUrl = this.settings.darkMap ? 
                    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' :
                    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                
                L.tileLayer(tileUrl, {
                    attribution: '¬© OpenStreetMap contributors',
                    noWrap: true
                }).addTo(this.map);
            }
            
            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.startGame());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.skipBtn.addEventListener('click', () => this.skipCity());
                this.hintBtn.addEventListener('click', () => this.showHint());
                this.resetBtn.addEventListener('click', () => this.resetGame());
                
                this.map.on('click', (e) => this.handleMapClick(e));
            }

            playSound(type) {
                if (!this.settings.sound) return;
                
                // Create simple audio feedback using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'correct') {
                    // Happy ascending tone
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                } else if (type === 'incorrect') {
                    // Sad descending tone
                    oscillator.frequency.setValueAtTime(392, audioContext.currentTime); // G4
                    oscillator.frequency.setValueAtTime(329.63, audioContext.currentTime + 0.1); // E4
                    oscillator.frequency.setValueAtTime(261.63, audioContext.currentTime + 0.2); // C4
                } else if (type === 'achievement') {
                    // Victory fanfare
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.15);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.3);
                    oscillator.frequency.setValueAtTime(1046.5, audioContext.currentTime + 0.45);
                }
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            showAchievement(title, description) {
                const achievementEl = document.getElementById('achievement');
                achievementEl.querySelector('.achievement-title').textContent = title;
                achievementEl.querySelector('.achievement-text').textContent = description;
                
                achievementEl.classList.add('show');
                this.playSound('achievement');
                
                setTimeout(() => {
                    achievementEl.classList.remove('show');
                }, 4000);
            }

            checkAchievements() {
                // First Correct Answer
                if (this.correctAnswers === 1 && !this.achievements.includes('first_correct')) {
                    this.achievements.push('first_correct');
                    this.showAchievement('üéØ First Success!', 'You got your first city correct!');
                }
                
                // Perfect Streak
                if (this.streak === 5 && !this.achievements.includes('streak_5')) {
                    this.achievements.push('streak_5');
                    this.showAchievement('üî• Hot Streak!', 'Five correct answers in a row!');
                }
                
                // Speed Demon
                if (this.bestTime && this.bestTime < 2000 && !this.achievements.includes('speed_demon')) {
                    this.achievements.push('speed_demon');
                    this.showAchievement('‚ö° Lightning Fast!', 'Answered in under 2 seconds!');
                }
                
                // Geography Expert
                if (this.score > 2000 && !this.achievements.includes('expert')) {
                    this.achievements.push('expert');
                    this.showAchievement('üåç Geography Expert!', 'Scored over 2000 points!');
                }
            }
            
            startGame() {
                // Check if cities are loaded
                if (this.cities.length === 0) {
                    this.showFeedback('‚ùå Cities data not loaded yet. Please wait...', 'incorrect');
                    return;
                }
                
                this.showLoading(true);
                
                setTimeout(() => {
                    this.gameActive = true;
                    this.startBtn.disabled = true;
                    this.pauseBtn.disabled = false;
                    this.skipBtn.disabled = false;
                    this.hintBtn.disabled = false;
                    this.leaderboardEl.style.display = 'none';
                    this.usedCities = [];
                    this.correctAnswers = 0;
                    this.totalAnswers = 0;
                    this.achievements = [];
                    this.showLoading(false);
                    this.nextRound();
                }, 1000);
            }

            showLoading(show) {
                document.getElementById('loading').classList.toggle('show', show);
            }
            
            nextRound() {
                if (!this.gameActive || this.round > 15 || this.cities.length === 0) {
                    this.endGame();
                    return;
                }
                
                this.clearMarkers();
                this.hintUsed = false;
                this.hintBtn.disabled = false;
                
                // FIXED: Better city selection logic
                let availableCities = this.cities.filter(city => !this.usedCities.includes(city.name));
                
                // If we've used all cities, reset the used list
                if (availableCities.length === 0) {
                    this.usedCities = [];
                    availableCities = this.cities;
                }
                
                // Select random city from available ones
                const randomIndex = Math.floor(Math.random() * availableCities.length);
                this.currentCity = availableCities[randomIndex];
                this.usedCities.push(this.currentCity.name);
                
                console.log('Selected city:', this.currentCity.name, 'Used cities:', this.usedCities.length);
                
                this.cityNameEl.textContent = this.currentCity.name;
                
                let hintText = this.currentCity.hint || 'No hint available';
                if (this.settings.countryHint && this.currentCity.country) {
                    hintText += ` ‚Ä¢ Located in ${this.currentCity.country}`;
                }
                this.cityHintEl.textContent = hintText;
                
                this.timeLeft = this.settings.timePressure ? 7000 : 10000;
                this.startTime = Date.now();
                this.startTimer();
            }
            
            startTimer() {
                clearInterval(this.timer);
                this.timer = setInterval(() => {
                    if (this.isPaused) return;
                    
                    this.timeLeft -= 100;
                    const percentage = (this.timeLeft / (this.settings.timePressure ? 7000 : 10000)) * 100;
                    this.timerFillEl.style.width = Math.max(0, percentage) + '%';
                    
                    if (this.timeLeft <= 0) {
                        this.handleTimeout();
                    }
                }, 100);
            }

            showHint() {
                if (!this.gameActive || !this.currentCity || this.hintUsed) return;
                
                this.hintUsed = true;
                this.score = Math.max(0, this.score - 25);
                
                const additionalHints = [];
                
                if (this.currentCity.population) {
                    additionalHints.push(`Population: ${this.currentCity.population}`);
                }
                if (this.currentCity.landmark) {
                    additionalHints.push(`Famous landmark: ${this.currentCity.landmark}`);
                }
                if (this.currentCity.country) {
                    additionalHints.push(`Country: ${this.currentCity.country}`);
                }
                additionalHints.push(`Coordinates: ${Math.abs(this.currentCity.lat).toFixed(1)}¬∞${this.currentCity.lat >= 0 ? 'N' : 'S'}, ${Math.abs(this.currentCity.lng).toFixed(1)}¬∞${this.currentCity.lng >= 0 ? 'E' : 'W'}`);
                
                const randomHint = additionalHints[Math.floor(Math.random() * additionalHints.length)];
                this.cityHintEl.textContent += ` ‚Ä¢ ${randomHint}`;
                this.hintBtn.disabled = true;
                
                this.showFeedback('Hint used (-25 points)', 'incorrect');
                this.updateDisplay();
            }
            
            handleMapClick(e) {
                if (!this.gameActive || this.isPaused || !this.currentCity) return;
                
                const clickLat = e.latlng.lat;
                const clickLng = e.latlng.lng;
                
                const distance = this.calculateDistance(
                    clickLat, clickLng,
                    this.currentCity.lat, this.currentCity.lng
                );
                
                const tolerance = this.getCurrentTolerance();
                const isCorrect = distance < tolerance;
                
                this.addClickMarker(clickLat, clickLng, isCorrect);
                this.totalAnswers++;
                
                if (isCorrect) {
                    this.correctAnswers++;
                    this.handleCorrectClick(distance);
                } else {
                    this.handleIncorrectClick(distance);
                }
                
                this.updateAccuracy();
            }

            updateAccuracy() {
                if (this.totalAnswers > 0) {
                    this.accuracy = Math.round((this.correctAnswers / this.totalAnswers) * 100);
                    this.accuracyEl.textContent = this.accuracy + '%';
                }
            }
            
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371;
                const dLat = this.toRadians(lat2 - lat1);
                const dLng = this.toRadians(lng2 - lng1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
            
            toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }
            
            getCurrentTolerance() {
                const zoom = this.map.getZoom();
                const difficulty = Math.min(3, Math.ceil(this.round / 5));
                
                let baseTolerance = 500;
                baseTolerance *= (6 - this.settings.difficulty) / 5; // Adjust for user setting
                
                if (difficulty === 2) baseTolerance *= 0.6;
                if (difficulty === 3) baseTolerance *= 0.4;
                
                const zoomFactor = Math.max(0.5, (8 - zoom) / 6);
                return baseTolerance * zoomFactor;
            }
            
            addClickMarker(lat, lng, isCorrect) {
                const marker = L.circleMarker([lat, lng], {
                    radius: 12,
                    className: isCorrect ? 'correct-marker' : 'click-marker',
                    color: isCorrect ? '#27ae60' : '#e74c3c',
                    fillColor: isCorrect ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)',
                    fillOpacity: 0.8,
                    weight: 3
                }).addTo(this.map);
                
                this.markers.push(marker);
                
                if (!this.settings.reducedAnim) {
                    setTimeout(() => {
                        if (this.map.hasLayer(marker)) {
                            this.map.removeLayer(marker);
                            this.markers = this.markers.filter(m => m !== marker);
                        }
                    }, 1500);
                }
            }
            
            showCityLocation() {
                const correctMarker = L.circleMarker([this.currentCity.lat, this.currentCity.lng], {
                    radius: 15,
                    color: '#27ae60',
                    fillColor: '#2ecc71',
                    fillOpacity: 0.9,
                    weight: 4
                }).addTo(this.map);
                
                let popupContent = `<div style="text-align: center; color: #2c3e50;"><strong>${this.currentCity.name}</strong>`;
                if (this.currentCity.country) {
                    popupContent += `<br>${this.currentCity.country}`;
                }
                if (this.currentCity.landmark) {
                    popupContent += `<br><small>${this.currentCity.landmark}</small>`;
                }
                popupContent += `</div>`;
                
                correctMarker.bindPopup(popupContent).openPopup();
                
                this.markers.push(correctMarker);
                
                setTimeout(() => {
                    if (this.map.hasLayer(correctMarker)) {
                        this.map.removeLayer(correctMarker);
                        this.markers = this.markers.filter(m => m !== correctMarker);
                    }
                }, 4000);
            }
            
            clearMarkers() {
                this.markers.forEach(marker => {
                    if (this.map.hasLayer(marker)) {
                        this.map.removeLayer(marker);
                    }
                });
                this.markers = [];
            }
            
            handleCorrectClick(distance) {
                clearInterval(this.timer);
                
                const responseTime = Date.now() - this.startTime;
                const maxTime = this.settings.timePressure ? 7000 : 10000;
                const timeBonus = Math.max(0, Math.floor((this.timeLeft / maxTime) * 100));
                const accuracyBonus = Math.max(0, Math.floor(300 - distance / 2));
                const streakBonus = this.streak * 15;
                const hintPenalty = this.hintUsed ? 25 : 0;
                const roundScore = 100 + timeBonus + accuracyBonus + streakBonus - hintPenalty;
                
                this.score += roundScore;
                this.streak++;
                
                if (!this.bestTime || responseTime < this.bestTime) {
                    this.bestTime = responseTime;
                }
                
                this.playSound('correct');
                this.showCityLocation();
                this.showFeedback(`üéâ +${roundScore} points! (${Math.round(distance)}km away)`, 'correct');
                this.updateDisplay();
                this.checkAchievements();
                
                setTimeout(() => {
                    this.round++;
                    this.nextRound();
                }, 3500);
            }
            
            handleIncorrectClick(distance) {
                this.score = Math.max(0, this.score - 25);
                this.streak = 0;
                this.playSound('incorrect');
                this.showFeedback(`‚ùå -25 points (${Math.round(distance)}km away)`, 'incorrect');
                this.updateDisplay();
            }
            
            handleTimeout() {
                clearInterval(this.timer);
                this.streak = 0;
                this.totalAnswers++;
                this.updateAccuracy();
                this.showCityLocation();
                this.showFeedback('‚è∞ Time\'s up!', 'incorrect');
                this.updateDisplay();
                
                setTimeout(() => {
                    this.round++;
                    this.nextRound();
                }, 4000);
            }
            
            skipCity() {
                if (!this.gameActive || !this.currentCity) return;
                
                clearInterval(this.timer);
                this.score = Math.max(0, this.score - 50);
                this.streak = 0;
                this.totalAnswers++;
                this.updateAccuracy();
                this.showCityLocation();
                this.showFeedback('‚è≠Ô∏è City skipped (-50 points)', 'incorrect');
                this.updateDisplay();
                
                setTimeout(() => {
                    this.round++;
                    this.nextRound();
                }, 3500);
            }
            
            showFeedback(message, type) {
                const existingFeedback = document.querySelector('.feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                const feedback = document.createElement('div');
                feedback.className = `feedback ${type}`;
                feedback.textContent = message;
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 3000);
            }
            
            togglePause() {
                this.isPaused = !this.isPaused;
                this.pauseBtn.innerHTML = this.isPaused ? 
                    '<i class="fas fa-play"></i> Resume' : 
                    '<i class="fas fa-pause"></i> Pause';
                
                if (this.isPaused) {
                    this.cityNameEl.textContent = '‚è∏Ô∏è Game Paused';
                    this.cityHintEl.textContent = 'Click Resume to continue playing';
                } else if (this.currentCity) {
                    this.cityNameEl.textContent = this.currentCity.name;
                    let hintText = this.currentCity.hint || 'No hint available';
                    if (this.settings.countryHint && this.currentCity.country) {
                        hintText += ` ‚Ä¢ Located in ${this.currentCity.country}`;
                    }
                    this.cityHintEl.textContent = hintText;
                }
            }
            
            endGame() {
                this.gameActive = false;
                clearInterval(this.timer);
                this.clearMarkers();
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.skipBtn.disabled = true;
                this.hintBtn.disabled = true;
                
                this.saveHighScore();
                this.saveStats();
                this.showGameOver();
                this.showLeaderboard();
            }
            
            showGameOver() {
                let performanceMessage = '';
                if (this.accuracy >= 90) performanceMessage = 'üèÜ Outstanding performance!';
                else if (this.accuracy >= 75) performanceMessage = 'üéñÔ∏è Great job!';
                else if (this.accuracy >= 60) performanceMessage = 'üëç Good effort!';
                else performanceMessage = 'üìö Keep practicing!';
                
                this.cityNameEl.innerHTML = `
                    <div style="background: linear-gradient(45deg, var(--success-color), #2ecc71); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                        <h2 style="margin-bottom: 15px;">üéâ Game Complete!</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div>
                                <div style="font-size: 2em; font-weight: bold;">${this.score}</div>
                                <div style="opacity: 0.9;">Final Score</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: bold;">${this.round - 1}</div>
                                <div style="opacity: 0.9;">Rounds</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: bold;">${this.accuracy}%</div>
                                <div style="opacity: 0.9;">Accuracy</div>
                            </div>
                            <div>
                                <div style="font-size: 2em; font-weight: bold;">${this.bestTime ? (this.bestTime/1000).toFixed(1) + 's' : '--'}</div>
                                <div style="opacity: 0.9;">Best Time</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; font-size: 1.1em;">${performanceMessage}</p>
                    </div>
                `;
                this.cityHintEl.textContent = '';
            }
            
            resetGame() {
                clearInterval(this.timer);
                this.clearMarkers();
                
                this.score = 0;
                this.round = 1;
                this.streak = 0;
                this.bestTime = null;
                this.accuracy = 100;
                this.currentCity = null;
                this.gameActive = false;
                this.isPaused = false;
                this.usedCities = [];
                this.correctAnswers = 0;
                this.totalAnswers = 0;
                this.achievements = [];
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.skipBtn.disabled = true;
                this.hintBtn.disabled = true;
                this.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                
                this.cityNameEl.textContent = 'Click "Start Game" to begin!';
                this.cityHintEl.textContent = 'Test your geography knowledge by clicking cities on the world map';
                this.timerFillEl.style.width = '100%';
                
                this.map.setView([20, 0], 2);
                this.updateDisplay();
                this.showLeaderboard();
            }
            
            updateDisplay() {
                this.scoreEl.textContent = this.score.toLocaleString();
                this.roundEl.textContent = this.round;
                this.streakEl.textContent = this.streak;
                this.bestTimeEl.textContent = this.bestTime ? (this.bestTime/1000).toFixed(1) + 's' : '--';
                this.accuracyEl.textContent = this.accuracy + '%';
            }
            
            saveHighScore() {
                const newScore = {
                    score: this.score,
                    rounds: this.round - 1,
                    accuracy: this.accuracy,
                    bestTime: this.bestTime,
                    date: new Date().toLocaleDateString(),
                    achievements: this.achievements.length
                };
                
                this.highScores.push(newScore);
                this.highScores.sort((a, b) => b.score - a.score);
                this.highScores = this.highScores.slice(0, 5);
                
                try {
                    localStorage.setItem('civile_highscores', JSON.stringify(this.highScores));
                } catch (error) {
                    console.error('Error saving high scores:', error);
                }
            }
            
            loadHighScores() {
                try {
                    const saved = localStorage.getItem('civile_highscores');
                    if (saved) {
                        this.highScores = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Error loading high scores:', error);
                }
            }
            
            showLeaderboard() {
                this.loadHighScores();
                
                if (this.highScores.length === 0) {
                    this.leaderboardEl.style.display = 'none';
                    return;
                }
                
                this.leaderboardEl.style.display = 'block';
                this.scoresListEl.innerHTML = this.highScores.map((score, index) => `
                    <div class="score-entry">
                        <div class="score-rank">#${index + 1}</div>
                        <div class="score-details">
                            <div class="score-main">${score.score.toLocaleString()} points</div>
                            <div class="score-meta">${score.rounds} rounds ‚Ä¢ ${score.accuracy}% accuracy</div>
                        </div>
                        <div class="score-date">${score.date}</div>
                    </div>
                `).join('');
            }
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');
        }

        // Game Modes Dropdown
        function setupGameModesDropdown() {
            const gameModesBtn = document.getElementById('gameModesBtn');
            const gameModesDropdown = document.getElementById('gameModesDropdown');
            
            if (gameModesBtn && gameModesDropdown) {
                gameModesBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    gameModesDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    gameModesDropdown.classList.remove('show');
                });
                
                // Prevent dropdown from closing when clicking inside
                gameModesDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
        }

        // Settings Functions
        function toggleSetting(setting) {
            const toggle = document.getElementById(setting + 'Toggle');
            const isActive = toggle.classList.contains('active');
            
            toggle.classList.toggle('active', !isActive);
            gameSettings[setting] = !isActive;
            
            if (window.game) {
                window.game.settings[setting] = !isActive;
                window.game.saveSettings();
                
                // Apply setting changes
                if (setting === 'darkMap') {
                    window.game.updateMapTheme();
                }
            }
        }

        function updateDifficulty(value) {
            gameSettings.difficulty = parseInt(value);
            if (window.game) {
                window.game.settings.difficulty = parseInt(value);
                window.game.saveSettings();
            }
        }

        // Initialize settings display
        function initializeSettings() {
            Object.keys(gameSettings).forEach(setting => {
                const toggle = document.getElementById(setting + 'Toggle');
                if (toggle) {
                    toggle.classList.toggle('active', gameSettings[setting]);
                }
            });
            
            const difficultySlider = document.getElementById('difficultySlider');
            if (difficultySlider) {
                difficultySlider.value = gameSettings.difficulty;
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            initializeSettings();
            setupGameModesDropdown();
            window.game = new EnhancedCivileGame();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (!window.game.gameActive) return;
                
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        window.game.togglePause();
                        break;
                    case 's':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            window.game.skipCity();
                        }
                        break;
                    case 'h':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            window.game.showHint();
                        }
                        break;
                    case 'r':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            window.game.resetGame();
                        }
                        break;
                }
            });
            
            // Add fullscreen support
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F11') {
                    e.preventDefault();
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                }
            });
        });

        // Add smooth scrolling for better UX
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Performance optimization: Lazy load map tiles
        if ('IntersectionObserver' in window) {
            const mapObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && window.game && window.game.map) {
                        window.game.map.invalidateSize();
                    }
                });
            });
            
            setTimeout(() => {
                const mapElement = document.getElementById('map');
                if (mapElement) {
                    mapObserver.observe(mapElement);
                }
            }, 1000);
        }
    </script>
</body>
</html>
