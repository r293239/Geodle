<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civile - Geography Challenge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
        }

        .game-header {
            text-align: center;
            padding: 20px;
            width: 100%;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
        }

        .game-container {
            flex: 1;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .city-prompt {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .city-name {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .city-hint {
            font-size: 1.1em;
            color: #7f8c8d;
            font-style: italic;
        }

        .timer-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            transition: width 0.1s linear;
            border-radius: 4px;
        }

        #map {
            width: 100%;
            max-width: 800px;
            height: 400px;
            border-radius: 15px;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .leaflet-container {
            background: #1a73e8 !important;
        }

        .click-marker {
            background: rgba(231, 76, 60, 0.7);
            border: 3px solid #e74c3c;
            border-radius: 50%;
            animation: markerPulse 1s ease-out;
        }

        .correct-marker {
            background: rgba(39, 174, 96, 0.7);
            border-color: #27ae60;
        }

        @keyframes markerPulse {
            0% { 
                transform: scale(0.5);
                opacity: 1;
            }
            100% { 
                transform: scale(2);
                opacity: 0;
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 1000;
            animation: feedbackShow 2s ease-out forwards;
            pointer-events: none;
        }

        .feedback.correct {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .feedback.incorrect {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        @keyframes feedbackShow {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            80% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        .leaderboard {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .leaderboard h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .score-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .game-over {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .game-stats {
                gap: 15px;
            }
            
            .stat-item {
                padding: 8px 15px;
            }
            
            .city-name {
                font-size: 1.8em;
            }
            
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>üåç Civile</h1>
        <div class="game-stats">
            <div class="stat-item">
                <div>Score</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div>Round</div>
                <div class="stat-value" id="round">1</div>
            </div>
            <div class="stat-item">
                <div>Streak</div>
                <div class="stat-value" id="streak">0</div>
            </div>
            <div class="stat-item">
                <div>Best Time</div>
                <div class="stat-value" id="bestTime">--</div>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="city-prompt" id="cityPrompt">
            <div class="city-name" id="cityName">Click "Start Game" to begin!</div>
            <div class="city-hint" id="cityHint">Test your geography knowledge by clicking cities on the world map</div>
        </div>

        <div class="timer-bar">
            <div class="timer-fill" id="timerFill"></div>
        </div>

        <div id="map"></div>

        <div class="controls">
            <button id="startBtn">Start Game</button>
            <button id="pauseBtn" disabled>Pause</button>
            <button id="skipBtn" disabled>Skip City (-50 pts)</button>
            <button id="resetBtn">Reset Game</button>
        </div>

        <div class="leaderboard" id="leaderboard" style="display: none;">
            <h3>üèÜ High Scores</h3>
            <div id="scoresList"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // Load city data from external file
        let CITIES_DATA = [];

        // Load cities data
        async function loadCitiesData() {
            try {
                const response = await fetch('cities-data.json');
                CITIES_DATA = await response.json();
            } catch (error) {
                console.error('Failed to load cities data, using fallback:', error);
                // Fallback data if file loading fails
                CITIES_DATA = [
                    { name: "Paris", lat: 48.8566, lng: 2.3522, hint: "City of Light, home to the Eiffel Tower", difficulty: 1, country: "France", population: "2.1M" },
                    { name: "Tokyo", lat: 35.6762, lng: 139.6503, hint: "Japan's capital, famous for sushi and technology", difficulty: 1, country: "Japan", population: "37M" },
                    { name: "New York", lat: 40.7128, lng: -74.0060, hint: "The Big Apple, home to the Statue of Liberty", difficulty: 1, country: "USA", population: "8.3M" }
                ];
            }
        }

        class CivileGame {
            constructor() {
                this.cities = [];
                this.score = 0;
                this.round = 1;
                this.streak = 0;
                this.bestTime = null;
                this.currentCity = null;
                this.gameActive = false;
                this.isPaused = false;
                this.timer = null;
                this.timeLeft = 10000;
                this.startTime = 0;
                this.highScores = [];
                this.map = null;
                this.markers = [];
                
                this.initializeElements();
                this.initializeMap();
                this.setupEventListeners();
                this.updateDisplay();
                this.showLeaderboard();
            }
            
            async initialize() {
                await loadCitiesData();
                this.cities = CITIES_DATA;
            }
            
            initializeElements() {
                this.scoreEl = document.getElementById('score');
                this.roundEl = document.getElementById('round');
                this.streakEl = document.getElementById('streak');
                this.bestTimeEl = document.getElementById('bestTime');
                this.cityNameEl = document.getElementById('cityName');
                this.cityHintEl = document.getElementById('cityHint');
                this.timerFillEl = document.getElementById('timerFill');
                this.startBtn = document.getElementById('startBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.skipBtn = document.getElementById('skipBtn');
                this.resetBtn = document.getElementById('resetBtn');
                this.leaderboardEl = document.getElementById('leaderboard');
                this.scoresListEl = document.getElementById('scoresList');
            }
            
            initializeMap() {
                this.map = L.map('map', {
                    center: [20, 0],
                    zoom: 2,
                    minZoom: 2,
                    maxZoom: 6,
                    worldCopyJump: true,
                    maxBounds: [[-90, -180], [90, 180]],
                    maxBoundsViscosity: 1.0
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    noWrap: true
                }).addTo(this.map);

                // Disable default double-click zoom to prevent interference
                this.map.doubleClickZoom.disable();
            }
            
            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.startGame());
                this.pauseBtn.addEventListener('click', () => this.togglePause());
                this.skipBtn.addEventListener('click', () => this.skipCity());
                this.resetBtn.addEventListener('click', () => this.resetGame());
                
                this.map.on('click', (e) => this.handleMapClick(e));
            }
            
            async startGame() {
                if (this.cities.length === 0) {
                    await this.initialize();
                }
                
                this.gameActive = true;
                this.startBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.skipBtn.disabled = false;
                this.leaderboardEl.style.display = 'none';
                this.nextRound();
            }
            
            nextRound() {
                if (!this.gameActive || this.round > 15) {
                    this.endGame();
                    return;
                }
                
                // Clear previous markers
                this.clearMarkers();
                
                // Select city based on difficulty progression
                let difficulty = Math.min(3, Math.ceil(this.round / 5));
                let availableCities = this.cities.filter(city => city.difficulty === difficulty);
                
                if (availableCities.length === 0) {
                    availableCities = this.cities; // Fallback to all cities
                }
                
                this.currentCity = availableCities[Math.floor(Math.random() * availableCities.length)];
                
                this.cityNameEl.textContent = this.currentCity.name;
                this.cityHintEl.textContent = this.currentCity.hint;
                
                this.timeLeft = 10000;
                this.startTime = Date.now();
                this.startTimer();
            }
            
            startTimer() {
                clearInterval(this.timer);
                this.timer = setInterval(() => {
                    if (this.isPaused) return;
                    
                    this.timeLeft -= 100;
                    const percentage = (this.timeLeft / 10000) * 100;
                    this.timerFillEl.style.width = Math.max(0, percentage) + '%';
                    
                    if (this.timeLeft <= 0) {
                        this.handleTimeout();
                    }
                }, 100);
            }
            
            handleMapClick(e) {
                if (!this.gameActive || this.isPaused || !this.currentCity) return;
                
                const clickLat = e.latlng.lat;
                const clickLng = e.latlng.lng;
                
                // Calculate distance in kilometers
                const distance = this.calculateDistance(
                    clickLat, clickLng,
                    this.currentCity.lat, this.currentCity.lng
                );
                
                // Tolerance varies by zoom level and difficulty
                const tolerance = this.getCurrentTolerance();
                const isCorrect = distance < tolerance;
                
                // Add click marker
                this.addClickMarker(clickLat, clickLng, isCorrect);
                
                if (isCorrect) {
                    this.handleCorrectClick(distance);
                } else {
                    this.handleIncorrectClick(distance);
                }
            }
            
            calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Earth's radius in kilometers
                const dLat = this.toRadians(lat2 - lat1);
                const dLng = this.toRadians(lng2 - lng1);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
            
            toRadians(degrees) {
                return degrees * (Math.PI / 180);
            }
            
            getCurrentTolerance() {
                const zoom = this.map.getZoom();
                const difficulty = Math.min(3, Math.ceil(this.round / 5));
                
                // Base tolerance decreases with difficulty and increases with zoom
                let baseTolerance = 500; // 500km base
                
                // Adjust for difficulty
                if (difficulty === 2) baseTolerance = 300;
                if (difficulty === 3) baseTolerance = 200;
                
                // Adjust for zoom (more precise clicking at higher zoom)
                const zoomFactor = Math.max(0.5, (6 - zoom) / 4);
                
                return baseTolerance * zoomFactor;
            }
            
            addClickMarker(lat, lng, isCorrect) {
                const marker = L.circleMarker([lat, lng], {
                    radius: 10,
                    className: isCorrect ? 'correct-marker' : 'click-marker',
                    color: isCorrect ? '#27ae60' : '#e74c3c',
                    fillColor: isCorrect ? 'rgba(39, 174, 96, 0.7)' : 'rgba(231, 76, 60, 0.7)',
                    fillOpacity: 0.8,
                    weight: 3
                }).addTo(this.map);
                
                this.markers.push(marker);
                
                // Remove marker after animation
                setTimeout(() => {
                    this.map.removeLayer(marker);
                    this.markers = this.markers.filter(m => m !== marker);
                }, 1000);
            }
            
            showCityLocation() {
                // Show the correct city location
                const correctMarker = L.circleMarker([this.currentCity.lat, this.currentCity.lng], {
                    radius: 12,
                    color: '#27ae60',
                    fillColor: '#2ecc71',
                    fillOpacity: 0.9,
                    weight: 4
                }).addTo(this.map);
                
                correctMarker.bindPopup(`${this.currentCity.name}<br>${this.currentCity.country}`).openPopup();
                this.markers.push(correctMarker);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    this.map.removeLayer(correctMarker);
                    this.markers = this.markers.filter(m => m !== correctMarker);
                }, 3000);
            }
            
            clearMarkers() {
                this.markers.forEach(marker => {
                    this.map.removeLayer(marker);
                });
                this.markers = [];
            }
            
            handleCorrectClick(distance) {
                clearInterval(this.timer);
                
                const responseTime = Date.now() - this.startTime;
                const timeBonus = Math.max(0, Math.floor((this.timeLeft / 100)));
                const accuracyBonus = Math.max(0, Math.floor(200 - distance / 5)); // Bonus for accuracy
                const streakBonus = this.streak * 10;
                const roundScore = 100 + timeBonus + accuracyBonus + streakBonus;
                
                this.score += roundScore;
                this.streak++;
                
                if (!this.bestTime || responseTime < this.bestTime) {
                    this.bestTime = responseTime;
                }
                
                this.showCityLocation();
                this.showFeedback('correct', `+${roundScore} points! (${Math.round(distance)}km away)`);
                this.updateDisplay();
                
                setTimeout(() => {
                    this.round++;
                    this.nextRound();
                }, 3000);
            }
            
            handleIncorrectClick(distance) {
                this.score = Math.max(0, this.score - 25);
                this.streak = 0;
                this.showFeedback('incorrect', `-25 points (${Math.round(distance)}km away)`);
                this.updateDisplay();
            }
            
            handleTimeout() {
                clearInterval(this.timer);
                this.streak = 0;
                this.showCityLocation();
                this.showFeedback('incorrect', 'Time\'s up!');
                this.updateDisplay();
                
                setTimeout(() => {
                    this.round++;
                    this.nextRound();
                }, 3000);
            }
            
            skipCity() {
                if (!this.gameActive || !this.currentCity) return;
                
                clearInterval(this.timer);
                this.score = Math.max(0, this.score - 50);
                this.streak = 0;
                this.showCityLocation();
                this.showFeedback('incorrect', 'City skipped (-50 points)');
                this.updateDisplay();
                
                setTimeout(() => {
                    this.round++;
                    this.nextRound();
                }, 3000);
            }
            
            showFeedback(type, message) {
                const existingFeedback = document.querySelector('.feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                const feedback = document.createElement('div');
                feedback.className = `feedback ${type}`;
                feedback.textContent = message;
                document.body.appendChild(feedback);
                
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 2000);
            }
            
            togglePause() {
                this.isPaused = !this.isPaused;
                this.pauseBtn.textContent = this.isPaused ? 'Resume' : 'Pause';
                
                if (this.isPaused) {
                    this.cityNameEl.textContent = 'Game Paused';
                    this.cityHintEl.textContent = 'Click Resume to continue';
                } else if (this.currentCity) {
                    this.cityNameEl.textContent = this.currentCity.name;
                    this.cityHintEl.textContent = this.currentCity.hint;
                }
            }
            
            endGame() {
                this.gameActive = false;
                clearInterval(this.timer);
                this.clearMarkers();
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.skipBtn.disabled = true;
                
                this.saveHighScore();
                this.showGameOver();
                this.showLeaderboard();
            }
            
            showGameOver() {
                this.cityNameEl.innerHTML = `<div class="game-over">
                    <h2>üéâ Game Complete!</h2>
                    <p>Final Score: <strong>${this.score}</strong></p>
                    <p>Rounds Completed: <strong>${this.round - 1}/10</strong></p>
                    <p>Best Time: <strong>${this.bestTime ? (this.bestTime/1000).toFixed(1) + 's' : '--'}</strong></p>
                </div>`;
                this.cityHintEl.textContent = '';
            }
            
            resetGame() {
                clearInterval(this.timer);
                this.clearMarkers();
                
                this.score = 0;
                this.round = 1;
                this.streak = 0;
                this.bestTime = null;
                this.currentCity = null;
                this.gameActive = false;
                this.isPaused = false;
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.skipBtn.disabled = true;
                this.pauseBtn.textContent = 'Pause';
                
                this.cityNameEl.textContent = 'Click "Start Game" to begin!';
                this.cityHintEl.textContent = 'Test your geography knowledge by clicking cities on the world map';
                this.timerFillEl.style.width = '100%';
                
                // Reset map view
                this.map.setView([20, 0], 2);
                
                this.updateDisplay();
                this.showLeaderboard();
            }
            
            updateDisplay() {
                this.scoreEl.textContent = this.score;
                this.roundEl.textContent = this.round;
                this.streakEl.textContent = this.streak;
                this.bestTimeEl.textContent = this.bestTime ? (this.bestTime/1000).toFixed(1) + 's' : '--';
            }
            
            saveHighScore() {
                const newScore = {
                    score: this.score,
                    rounds: this.round - 1,
                    bestTime: this.bestTime,
                    date: new Date().toLocaleDateString()
                };
                
                this.highScores.push(newScore);
                this.highScores.sort((a, b) => b.score - a.score);
                this.highScores = this.highScores.slice(0, 5);
            }
            
            showLeaderboard() {
                if (this.highScores.length === 0) {
                    this.leaderboardEl.style.display = 'none';
                    return;
                }
                
                this.leaderboardEl.style.display = 'block';
                this.scoresListEl.innerHTML = this.highScores.map((score, index) => `
                    <div class="score-entry">
                        <span>${index + 1}. ${score.score} pts (${score.rounds} rounds)</span>
                        <span>${score.bestTime ? (score.bestTime/1000).toFixed(1) + 's' : '--'}</span>
                    </div>
                `).join('');
            }
        }
        
        // Initialize game when page loads
        window.addEventListener('load', () => {
            new CivileGame();
        });
    </script>
</body>
</html>
