<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Geodle - Daily Geography Clue Game</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 480px;
    margin: 20px auto;
    padding: 10px;
    background: #f0f4f8;
    color: #222;
  }
  h1 {
    text-align: center;
    margin-bottom: 5px;
  }
  #worldMap {
    height: 300px;
    width: 100%;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  #clueBox {
    background: #d0e2ff;
    padding: 12px;
    margin: 20px 0;
    font-weight: bold;
    font-size: 1.2em;
    border-radius: 8px;
    text-align: center;
  }
  #progressInfo {
    text-align: center;
    margin: 15px 0;
    font-size: 1.1em;
    color: #0078d7;
  }
  #progressBar {
    width: 100%;
    height: 20px;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
  }
  #progressFill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.3s ease;
    width: 10%;
  }
  #guessForm {
    display: flex;
    justify-content: center;
    margin-bottom: 10px;
  }
  #guessInput {
    flex: 1;
    font-size: 1em;
    padding: 8px;
    border: 2px solid #0078d7;
    border-radius: 4px 0 0 4px;
    outline: none;
  }
  #guessButton {
    padding: 8px 15px;
    font-size: 1em;
    background: #0078d7;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 0 4px 4px 0;
    transition: background 0.3s;
  }
  #guessButton:hover:not(:disabled) {
    background: #005a9e;
  }
  #guessButton:disabled {
    background: #cccccc;
    cursor: not-allowed;
  }
  #feedback {
    text-align: center;
    font-weight: bold;
    margin: 10px 0;
  }
  #pastHints {
    margin-top: 10px;
  }
  #pastHints h3 {
    margin-bottom: 6px;
  }
  #pastHintsList {
    list-style: none;
    padding-left: 0;
    max-height: 200px;
    overflow-y: auto;
  }
  #pastHintsList li {
    padding: 4px 8px;
    background: #e8f4fd;
    margin-bottom: 3px;
    border-radius: 4px;
    font-size: 0.9em;
    border-left: 3px solid #0078d7;
  }
  #history {
    margin-top: 10px;
  }
  #history h3 {
    margin-bottom: 6px;
  }
  #historyList {
    list-style: none;
    padding-left: 0;
  }
  #historyList li {
    padding: 6px 10px;
    background: white;
    margin-bottom: 4px;
    border-radius: 4px;
    box-shadow: 0 0 3px #aaa;
    font-size: 0.95em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #historyList li.correct {
    background: #c8e6c9;
    color: #2e7d32;
  }
  #historyList li.incorrect {
    background: #ffcdd2;
    color: #c62828;
  }
  #streak {
    text-align: center;
    font-size: 1.1em;
    margin: 12px 0;
    color: #0078d7;
    font-weight: bold;
  }
  #endScreen {
    background: #c2f0c2;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    text-align: center;
    display: none;
  }
  #shareBtn {
    margin-top: 12px;
    background: #0078d7;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 1em;
    border-radius: 6px;
    margin-right: 10px;
  }
  #dailyLimitMsg {
    background: #ffd3d3;
    border: 1px solid #d64c4c;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    color: #d64c4c;
    font-weight: bold;
    margin: 20px 0;
  }
  #newGameBtn {
    background: #ff9800;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 1em;
    border-radius: 6px;
    margin-top: 10px;
  }
  #newGameBtn:hover {
    background: #f57c00;
  }
  #resetBtn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 1em;
    border-radius: 6px;
    margin: 10px auto;
    display: block;
  }
  #resetBtn:hover {
    background: #c82333;
  }
  #resetWinsBtn {
    background: #6f42c1;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    font-size: 1em;
    border-radius: 6px;
    margin: 10px auto;
    display: block;
  }
  #resetWinsBtn:hover {
    background: #5a2d91;
  }
  #loadingError {
    background: #ffebee;
    border: 1px solid #f44336;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    color: #c62828;
    margin: 20px 0;
    display: none;
  }
  
  #help-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    text-decoration: none;
    z-index: 9999;
    transition: background-color 0.3s ease;
  }

  #help-button:hover {
    background-color: #0056b3;
  }

  /* Hidden admin panel styles */
  .admin-trigger {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    opacity: 0;
  }
  
  .admin-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: none;
    z-index: 10000;
  }
  
  .admin-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }
  
  .close-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
  }
  
  .sync-status {
    font-size: 12px;
    color: #666;
    margin-bottom: 15px;
    text-align: center;
    padding: 8px;
    border-radius: 5px;
    background: #f8f9fa;
  }
  
  .sync-status.synced {
    background: #d4edda;
    color: #155724;
  }
  
  .sync-status.error {
    background: #f8d7da;
    color: #721c24;
  }
  
  .stat-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stat-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
  }
  
  .stat-label {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 5px;
  }
  
  .admin-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .admin-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    flex: 1;
    min-width: 120px;
  }
  
  .admin-btn.danger {
    background: #dc3545;
  }
  
  .admin-btn.success {
    background: #28a745;
  }
  
  .visitor-log {
    max-height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
  }
  
  .log-entry {
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
    padding: 3px;
    background: white;
    border-radius: 3px;
  }
  
  .api-status {
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-top: 10px;
    font-style: italic;
  }
</style>
</head>
<body>
<h1>Geodle üåç</h1>
<div id="worldMap"></div>
<div id="progressInfo">
  <div>Clue <span id="currentClue">1</span> of 10</div>
  <div id="progressBar">
    <div id="progressFill"></div>
  </div>
</div>
<div id="clueBox">Loading clue...</div>
<form id="guessForm">
  <input type="text" id="guessInput" placeholder="Type your guess here" autocomplete="off" />
  <button id="guessButton" type="submit">Guess</button>
</form>
<div id="feedback"></div>
<div id="streak">üèÜ Total Wins: 0</div>
<button id="resetBtn">üîÑ Reset Game</button>
<button id="resetWinsBtn">üèÜ Reset Win Count</button>
<div id="pastHints">
  <h3>Past Hints</h3>
  <ul id="pastHintsList"></ul>
</div>
<div id="history">
  <h3>Guess History</h3>
  <ul id="historyList"></ul>
</div>
<div id="endScreen">
  <div id="resultMsg"></div>
  <button id="shareBtn">Share My Score</button>
  <button id="newGameBtn">New Game</button>
</div>
<div id="dailyLimitMsg" style="display:none;">
  You've already played today! Come back tomorrow üëÄ
</div>
<div id="loadingError">
  <h3>‚ö†Ô∏è Data Loading Error</h3>
  <p>Geography data is loaded inline. Game ready to play!</p>
</div>

<!-- Hidden admin trigger (invisible button) -->
<button class="admin-trigger" onclick="showAdminPanel()"></button>

<!-- Hidden admin panel -->
<div class="admin-panel" id="adminPanel">
  <div class="admin-content">
    <div class="admin-header">
      <h3>üìä Global Visitor Analytics</h3>
      <button class="close-btn" onclick="hideAdminPanel()">‚úï</button>
    </div>
    
    <div class="sync-status" id="syncStatus">
      üîÑ Checking sync status...
    </div>
    
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalVisitors">0</div>
        <div class="stat-label">Total Visitors</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="uniqueVisitors">0</div>
        <div class="stat-label">Unique Visitors</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="returnVisitors">0</div>
        <div class="stat-label">Return Visitors</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="todayVisitors">0</div>
        <div class="stat-label">Today's Visitors</div>
      </div>
    </div>
    
    <div class="admin-buttons">
      <button class="admin-btn success" onclick="syncData()">üîÑ Sync Now</button>
      <button class="admin-btn" onclick="exportData()">üì• Export Data</button>
      <button class="admin-btn danger" onclick="resetStats()">üóëÔ∏è Reset Stats</button>
    </div>
    
    <div>
      <strong>Recent Global Visits:</strong>
      <div class="visitor-log" id="visitorLog"></div>
    </div>
    
    <div class="api-status" id="apiStatus">
      Using JSONBin.io for cross-device sync
    </div>
  </div>
</div>

<!-- Sticky Help Button -->
<a id="help-button" 
   href="https://docs.google.com/forms/d/e/1FAIpQLSf66hYSFxnaQXvXmHlWU2MIGwIn3dkmiQ5iguGazXRKw4cSEg/viewform?usp=sharing&ouid=111077547070042896084" 
   target="_blank" 
   rel="noopener noreferrer">
  Help Us Improve
</a>

<script>
// Sample geography data (inline since data.js is not available)
const geographyData = [
  {
    name: "France",
    capital: "Paris",
    continent: "Europe",
    coordinates: [48.8566, 2.3522],
    clues: [
      "This country is famous for the Eiffel Tower",
      "Known for wine, cheese, and croissants",
      "The capital is called the City of Light",
      "Home to the Louvre Museum",
      "Famous for French cuisine and fashion",
      "Has a famous palace at Versailles",
      "Known for the French Riviera",
      "The language of love is spoken here",
      "Famous for the Tour de France cycling race",
      "Napoleon was from this country"
    ]
  },
  {
    name: "Japan",
    capital: "Tokyo",
    continent: "Asia",
    coordinates: [35.6762, 139.6503],
    clues: [
      "This island nation is famous for sushi",
      "Known for cherry blossoms (sakura)",
      "Home to Mount Fuji",
      "Famous for anime and manga",
      "The land of the rising sun",
      "Known for samurai and ninjas",
      "Famous for bullet trains (shinkansen)",
      "Tokyo is the world's largest metropolitan area",
      "Known for technology and robotics",
      "Famous for traditional tea ceremonies"
    ]
  },
  {
    name: "Brazil",
    capital: "Brasilia",
    continent: "South America",
    coordinates: [-15.8267, -47.9218],
    clues: [
      "This country is famous for the Amazon rainforest",
      "Home to the Christ the Redeemer statue in Rio",
      "Known for Carnival celebrations",
      "The largest country in South America",
      "Famous for football (soccer) and the World Cup",
      "Portuguese is the official language",
      "Known for beautiful beaches like Copacabana",
      "Home to the Amazon River",
      "Famous for samba dancing",
      "Coffee is a major export from this country"
    ]
  },
  {
    name: "Egypt",
    capital: "Cairo",
    continent: "Africa",
    coordinates: [30.0444, 31.2357],
    clues: [
      "This country is home to the Great Pyramids",
      "The Sphinx guards ancient monuments here",
      "The Nile River flows through this country",
      "Famous for ancient pharaohs and mummies",
      "Home to the Valley of the Kings",
      "Known for hieroglyphics",
      "The Suez Canal is located here",
      "Ancient civilization built massive temples",
      "Famous for archaeological discoveries",
      "Cleopatra ruled this ancient land"
    ]
  },
  {
    name: "Australia",
    capital: "Canberra",
    continent: "Australia",
    coordinates: [-35.2809, 149.1300],
    clues: [
      "This country is also a continent",
      "Home to kangaroos and koalas",
      "The Sydney Opera House is located here",
      "Known for the Great Barrier Reef",
      "The Outback covers much of this country",
      "Famous for Uluru (Ayers Rock)",
      "English is spoken with a unique accent",
      "Known for dangerous animals and spiders",
      "Melbourne hosts a famous tennis tournament",
      "The largest island country in the world"
    ]
  }
];

let currentQuestion = null;
let currentClueIndex = 0;
let guessHistory = [];
let gameEnded = false;
let totalWins = 0;
let worldMap = null;
let visitorTracker = null;

// Synced Visitor tracking system using JSONBin.io
class SyncedVisitorTracker {
  constructor() {
    this.storageKey = 'site_visitor_data';
    this.sessionKey = 'current_session';
    this.binId = '676088c4ad19ca34f8d4f5a8'; // JSONBin.io bin ID
    this.apiKey = '$2a$10$mGVFpVcjy4K5PdF9Q2XVFu1LgPUCHzRJ5kGd7WN0pO3nLqH4Mv8La'; // Read-only API key
    this.syncInterval = 30000; // Sync every 30 seconds
    this.lastSyncTime = 0;
    this.isOnline = navigator.onLine;
    
    this.init();
    this.setupOfflineDetection();
    this.startPeriodicSync();
  }
  
  init() {
    this.data = this.loadLocalData();
    this.trackVisit();
    this.syncFromCloud();
    this.updateDisplay();
  }
  
  setupOfflineDetection() {
    window.addEventListener('online', () => {
      this.isOnline = true;
      this.updateSyncStatus('üåê Back online - syncing data...');
      this.syncFromCloud();
    });
    
    window.addEventListener('offline', () => {
      this.isOnline = false;
      this.updateSyncStatus('üì¥ Offline - data saved locally');
    });
  }
  
  startPeriodicSync() {
    setInterval(() => {
      if (this.isOnline && Date.now() - this.lastSyncTime > this.syncInterval) {
        this.syncFromCloud();
      }
    }, this.syncInterval);
  }
  
  updateSyncStatus(message, isError = false) {
    const statusEl = document.getElementById('syncStatus');
    if (statusEl) {
      statusEl.textContent = message;
      statusEl.className = 'sync-status' + (isError ? ' error' : ' synced');
    }
  }
  
  loadLocalData() {
    try {
      const stored = localStorage.getItem(this.storageKey);
      if (stored) {
        const data = JSON.parse(stored);
        // Convert array back to Set if needed
        if (Array.isArray(data.uniqueVisitors)) {
          data.uniqueVisitors = new Set(data.uniqueVisitors);
        }
        return data;
      }
    } catch (e) {
      console.warn('Failed to parse local visitor data');
    }
    
    return this.createEmptyData();
  }
  
  createEmptyData() {
    return {
      totalVisits: 0,
      uniqueVisitors: new Set(),
      visitLog: [],
      firstVisit: new Date().toISOString(),
      lastVisit: null,
      lastSync: null
    };
  }
  
  saveLocalData() {
    try {
      const dataToStore = {
        ...this.data,
        uniqueVisitors: Array.from(this.data.uniqueVisitors),
        lastSync: new Date().toISOString()
      };
      
      localStorage.setItem(this.storageKey, JSON.stringify(dataToStore));
    } catch (e) {
      console.warn('Failed to save local visitor data');
    }
  }
  
  async syncToCloud() {
    if (!this.isOnline) return;
    
    try {
      const dataToSync = {
        ...this.data,
        uniqueVisitors: Array.from(this.data.uniqueVisitors),
        lastSync: new Date().toISOString(),
        syncSource: this.getDeviceFingerprint()
      };
      
      const response = await fetch(`https://api.jsonbin.io/v3/b/${this.binId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': this.apiKey
        },
        body: JSON.stringify(dataToSync)
      });
      
      if (response.ok) {
        this.lastSyncTime = Date.now();
        this.updateSyncStatus('‚úÖ Data synced across all devices');
      } else {
        throw new Error('Sync failed');
      }
    } catch (error) {
      console.warn('Failed to sync to cloud:', error);
      this.updateSyncStatus('‚ö†Ô∏è Sync failed - data saved locally', true);
    }
  }
  
  async syncFromCloud() {
    if (!this.isOnline) {
      this.updateSyncStatus('üì¥ Offline - using local data');
      return;
    }
    
    try {
      const response = await fetch(`https://api.jsonbin.io/v3/b/${this.binId}/latest`, {
        headers: {
          'X-Master-Key': this.apiKey
        }
      });
      
      if (response.ok) {
        const result = await response.json();
        const cloudData = result.record;
        
        // Merge cloud data with local data
        this.mergeData(cloudData);
        this.saveLocalData();
        this.updateDisplay();
        this.lastSyncTime = Date.now();
        this.updateSyncStatus('‚úÖ Synced with global data');
      } else {
        throw new Error('Failed to fetch cloud data');
      }
    } catch (error) {
      console.warn('Failed to sync from cloud:', error);
      this.updateSyncStatus('‚ö†Ô∏è Using local data only', true);
    }
  }
  
  mergeData(cloudData) {
    if (!cloudData) return;
    
    // Convert arrays back to Sets
    const cloudUniqueVisitors = new Set(Array.isArray(cloudData.uniqueVisitors) ? cloudData.uniqueVisitors : []);
    const localUniqueVisitors = new Set(Array.isArray(this.data.uniqueVisitors) ? this.data.uniqueVisitors : this.data.uniqueVisitors);
    
    // Merge unique visitors
    const mergedUniqueVisitors = new Set([...cloudUniqueVisitors, ...localUniqueVisitors]);
    
    // Merge visit logs and sort by timestamp
    const mergedVisitLog = [...(cloudData.visitLog || []), ...(this.data.visitLog || [])]
      .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
      .slice(0, 100); // Keep only latest 100 visits
    
    // Remove duplicates from visit log based on timestamp and visitor ID
    const uniqueVisitLog = [];
    const seenVisits = new Set();
    
    for (const visit of mergedVisitLog) {
      const visitKey = `${visit.id}-${visit.timestamp}`;
      if (!seenVisits.has(visitKey)) {
        seenVisits.add(visitKey);
        uniqueVisitLog.push(visit);
      }
    }
    
    // Update data
    this.data = {
      totalVisits: Math.max(cloudData.totalVisits || 0, this.data.totalVisits || 0),
      uniqueVisitors: mergedUniqueVisitors,
      visitLog: uniqueVisitLog.slice(0, 50), // Keep latest 50
      firstVisit: cloudData.firstVisit || this.data.firstVisit,
      lastVisit: this.getMostRecentDate(cloudData.lastVisit, this.data.lastVisit),
      lastSync: new Date().toISOString()
    };
  }
  
  getMostRecentDate(date1, date2) {
    if (!date1) return date2;
    if (!date2) return date1;
    return new Date(date1) > new Date(date2) ? date1 : date2;
  }
  
  getDeviceFingerprint() {
    // Simple device fingerprint for identifying sync source
    return btoa(`${navigator.userAgent}-${screen.width}x${screen.height}-${navigator.language}`).slice(0, 16);
  }
  
  generateVisitorId() {
    return 'visitor_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
  }
  
  getVisitorId() {
    let visitorId = localStorage.getItem('visitor_id');
    if (!visitorId) {
      visitorId = this.generateVisitorId();
      localStorage.setItem('visitor_id', visitorId);
    }
    return visitorId;
  }
  
  isNewSession() {
    const sessionId = sessionStorage.getItem(this.sessionKey);
    if (!sessionId) {
      sessionStorage.setItem(this.sessionKey, 'active');
      return true;
    }
    return false;
  }
  
  trackVisit() {
    if (!this.isNewSession()) return;
    
    const visitorId = this.getVisitorId();
    const now = new Date();
    const isUnique = !this.data.uniqueVisitors.has(visitorId);
    
    // Ensure uniqueVisitors is a Set
    if (Array.isArray(this.data.uniqueVisitors)) {
      this.data.uniqueVisitors = new Set(this.data.uniqueVisitors);
    }
    
    // Track the visit
    this.data.totalVisits++;
    this.data.uniqueVisitors.add(visitorId);
    this.data.lastVisit = now.toISOString();
    
    // Add to visit log
    this.data.visitLog.unshift({
      id: visitorId.slice(-6),
      timestamp: now.toISOString(),
      isUnique: isUnique,
      userAgent: navigator.userAgent.slice(0, 50) + '...',
      device: this.getDeviceFingerprint()
    });
    
    // Keep only last 50 visits
    this.data.visitLog = this.data.visitLog.slice(0, 50);
    
    this.saveLocalData();
    
    // Sync to cloud after a short delay
    setTimeout(() => this.syncToCloud(), 2000);
  }
  
  getStats() {
    // Ensure uniqueVisitors is a Set
    if (Array.isArray(this.data.uniqueVisitors)) {
      this.data.uniqueVisitors = new Set(this.data.uniqueVisitors);
    }
    
    const today = new Date().toDateString();
    const todayVisits = this.data.visitLog.filter(visit => 
      new Date(visit.timestamp).toDateString() === today
    ).length;
    
    return {
      totalVisitors: this.data.totalVisits,
      uniqueVisitors: this.data.uniqueVisitors.size,
      returnVisitors: this.data.totalVisits - this.data.uniqueVisitors.size,
      todayVisitors: todayVisits,
      recentVisits: this.data.visitLog.slice(0, 10)
    };
  }
  
  updateDisplay() {
    const stats = this.getStats();
    
    const elements = {
      totalVisitors: document.getElementById('totalVisitors'),
      uniqueVisitors: document.getElementById('uniqueVisitors'),
      returnVisitors: document.getElementById('returnVisitors'),
      todayVisitors: document.getElementById('todayVisitors'),
      visitorLog: document.getElementById('visitorLog')
    };
    
    if (elements.totalVisitors) elements.totalVisitors.textContent = stats.totalVisitors;
    if (elements.uniqueVisitors) elements.uniqueVisitors.textContent = stats.uniqueVisitors;
    if (elements.returnVisitors) elements.returnVisitors.textContent = stats.returnVisitors;
    if (elements.todayVisitors) elements.todayVisitors.textContent = stats.todayVisitors;
    
    if (elements.visitorLog) {
      elements.visitorLog.innerHTML = stats.recentVisits.map(visit => {
        const date = new Date(visit.timestamp).toLocaleDateString();
        const time = new Date(visit.timestamp).toLocaleTimeString();
        const uniqueLabel = visit.isUnique ? 'üë§ New' : 'üîÑ Return';
        return `<div class="log-entry">${uniqueLabel} - ${date} ${time} (ID: ${visit.id})</div>`;
      }).join('');
    }
  }
  
  resetStats() {
    this.data = this.createEmptyData();
    this.saveLocalData();
    this.updateDisplay();
    this.syncToCloud();
  }
  
  exportData() {
    const dataToExport = {
      ...this.data,
      uniqueVisitors: Array.from(this.data.uniqueVisitors),
      exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], {
      type: 'application/json'
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `visitor-data-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }
}

// Initialize the game when the page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeMap();
  loadGameState();
  startNewGame();
  
  // Initialize visitor tracking
  visitorTracker = new SyncedVisitorTracker();
  
  // Set up event listeners
  document.getElementById('guessForm').addEventListener('submit', handleGuess);
  document.getElementById('resetBtn').addEventListener('click', resetGame);
  document.getElementById('resetWinsBtn').addEventListener('click', resetWins);
  document.getElementById('shareBtn').addEventListener('click', shareScore);
  document.getElementById('newGameBtn').addEventListener('click', startNewGame);
});

function initializeMap() {
  try {
    worldMap = L.map('worldMap').setView([20, 0], 2);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 18
    }).addTo(worldMap);
    
    // Disable zoom controls for mobile
    worldMap.touchZoom.disable();
    worldMap.doubleClickZoom.disable();
    worldMap.scrollWheelZoom.disable();
    worldMap.boxZoom.disable();
    worldMap.keyboard.disable();
    worldMap.dragging.disable();
    
  } catch (error) {
    console.error('Error initializing map:', error);
    document.getElementById('worldMap').innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Map unavailable</div>';
  }
}

function loadGameState() {
  try {
    const savedWins = localStorage.getItem('geodle_total_wins');
    if (savedWins) {
      totalWins = parseInt(savedWins) || 0;
    }
    updateWinDisplay();
  } catch (error) {
    console.warn('Could not load game state:', error);
  }
}

function saveGameState() {
  try {
    localStorage.setItem('geodle_total_wins', totalWins.toString());
  } catch (error) {
    console.warn('Could not save game state:', error);
  }
}

function startNewGame() {
  // Reset game state
  currentQuestion = getRandomQuestion();
  currentClueIndex = 0;
  guessHistory = [];
  gameEnded = false;
  
  // Reset UI
  document.getElementById('endScreen').style.display = 'none';
  document.getElementById('dailyLimitMsg').style.display = 'none';
  document.getElementById('loadingError').style.display = 'none';
  document.getElementById('guessInput').disabled = false;
  document.getElementById('guessButton').disabled = false;
  document.getElementById('guessInput').value = '';
  document.getElementById('feedback').textContent = '';
  
  // Clear lists
  document.getElementById('pastHintsList').innerHTML = '';
  document.getElementById('historyList').innerHTML = '';
  
  // Show first clue
  showNextClue();
  updateProgress();
  
  // Update map marker
  updateMapMarker();
}

function getRandomQuestion() {
  return geographyData[Math.floor(Math.random() * geographyData.length)];
}

function showNextClue() {
  if (currentClueIndex < currentQuestion.clues.length) {
    const clue = currentQuestion.clues[currentClueIndex];
    document.getElementById('clueBox').textContent = clue;
    
    // Add to past hints
    const hintsList = document.getElementById('pastHintsList');
    const listItem = document.createElement('li');
    listItem.textContent = `${currentClueIndex + 1}. ${clue}`;
    hintsList.appendChild(listItem);
    
    currentClueIndex++;
    updateProgress();
  }
}

function updateProgress() {
  document.getElementById('currentClue').textContent = currentClueIndex;
  const progressPercent = (currentClueIndex / 10) * 100;
  document.getElementById('progressFill').style.width = progressPercent + '%';
}

function updateMapMarker() {
  if (!worldMap || !currentQuestion) return;
  
  try {
    // Clear existing markers
    worldMap.eachLayer(function(layer) {
      if (layer instanceof L.Marker) {
        worldMap.removeLayer(layer);
      }
    });
    
    // Add marker for current question
    const [lat, lng] = currentQuestion.coordinates;
    L.marker([lat, lng])
      .addTo(worldMap)
      .bindPopup(`${currentQuestion.name}, ${currentQuestion.continent}`)
      .openPopup();
    
    // Center map on the location
    worldMap.setView([lat, lng], 4);
  } catch (error) {
    console.warn('Could not update map marker:', error);
  }
}

function handleGuess(event) {
  event.preventDefault();
  
  if (gameEnded) return;
  
  const guess = document.getElementById('guessInput').value.trim();
  if (!guess) return;
  
  const isCorrect = guess.toLowerCase() === currentQuestion.name.toLowerCase() ||
                   guess.toLowerCase() === currentQuestion.capital.toLowerCase();
  
  // Add to guess history
  const historyList = document.getElementById('historyList');
  const listItem = document.createElement('li');
  listItem.className = isCorrect ? 'correct' : 'incorrect';
  listItem.innerHTML = `
    <span>${guess}</span>
    <span>${isCorrect ? '‚úÖ' : '‚ùå'}</span>
  `;
  historyList.insertBefore(listItem, historyList.firstChild);
  
  guessHistory.push({ guess, isCorrect });
  
  if (isCorrect) {
    // Correct guess - end game
    endGame(true);
  } else {
    // Incorrect guess
    document.getElementById('feedback').textContent = 'Not quite right. Try again!';
    document.getElementById('feedback').style.color = '#c62828';
    
    if (currentClueIndex >= 10) {
      // No more clues - end game
      endGame(false);
    } else {
      // Show next clue
      setTimeout(() => {
        showNextClue();
        document.getElementById('feedback').textContent = '';
      }, 1500);
    }
  }
  
  // Clear input
  document.getElementById('guessInput').value = '';
}

function endGame(won) {
  gameEnded = true;
  document.getElementById('guessInput').disabled = true;
  document.getElementById('guessButton').disabled = true;
  
  const endScreen = document.getElementById('endScreen');
  const resultMsg = document.getElementById('resultMsg');
  
  if (won) {
    totalWins++;
    saveGameState();
    updateWinDisplay();
    
    resultMsg.innerHTML = `
      <h3>üéâ Congratulations!</h3>
      <p>You guessed <strong>${currentQuestion.name}</strong> correctly!</p>
      <p>It took you ${currentClueIndex} clue${currentClueIndex === 1 ? '' : 's'}.</p>
    `;
    endScreen.style.background = '#c8e6c9';
  } else {
    resultMsg.innerHTML = `
      <h3>ü§î Game Over</h3>
      <p>The answer was <strong>${currentQuestion.name}</strong> (${currentQuestion.capital}).</p>
      <p>Better luck next time!</p>
    `;
    endScreen.style.background = '#ffcdd2';
  }
  
  endScreen.style.display = 'block';
  
  // Show the answer on the map
  updateMapMarker();
}

function updateWinDisplay() {
  document.getElementById('streak').textContent = `üèÜ Total Wins: ${totalWins}`;
}

function resetGame() {
  if (confirm('Are you sure you want to start a new game?')) {
    startNewGame();
  }
}

function resetWins() {
  if (confirm('Are you sure you want to reset your win count?')) {
    totalWins = 0;
    saveGameState();
    updateWinDisplay();
  }
}

function shareScore() {
  const cluesUsed = currentClueIndex;
  const shareText = gameEnded && guessHistory.some(g => g.isCorrect) 
    ? `I guessed ${currentQuestion.name} in ${cluesUsed} clue${cluesUsed === 1 ? '' : 's'} on Geodle! üåç Total wins: ${totalWins}`
    : `I played Geodle but couldn't guess ${currentQuestion.name}! ü§î Total wins: ${totalWins}`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Geodle - Geography Game',
      text: shareText,
      url: window.location.href
    });
  } else {
    // Fallback - copy to clipboard
    navigator.clipboard.writeText(shareText + ' ' + window.location.href).then(() => {
      alert('Score copied to clipboard!');
    }).catch(() => {
      alert('Share text: ' + shareText);
    });
  }
}

// Admin panel functions
function showAdminPanel() {
  document.getElementById('adminPanel').style.display = 'block';
  if (visitorTracker) {
    visitorTracker.updateDisplay();
  }
}

function hideAdminPanel() {
  document.getElementById('adminPanel').style.display = 'none';
}

function syncData() {
  if (visitorTracker) {
    visitorTracker.syncFromCloud();
  }
}

function exportData() {
  if (visitorTracker) {
    visitorTracker.exportData();
  }
}

function resetStats() {
  if (confirm('Are you sure you want to reset all visitor statistics?')) {
    if (visitorTracker) {
      visitorTracker.resetStats();
    }
  }
}
